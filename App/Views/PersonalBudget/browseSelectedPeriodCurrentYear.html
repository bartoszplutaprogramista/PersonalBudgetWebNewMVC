{% extends 'base.html' %}

{% block title2 %}Przeglądaj bilans dla bieżącego roku{% endblock %}

{% block body2 %}

<div class="row justify-content-center m-0 p-0">
    <div class="col-xl-12 col-xxl-9 p-0">
        <div class="content mt-2 p-4">
            <h3>PRZEGLĄDAJ BILANS BIEŻĄCY ROK</h3>
            <div class="d-flex flex-row bd-highlight div-balance-buttons mx-auto p-2 mb-2">
                <div class="bd-highlight balance-width d-flex align-items-center">
                    <label class="p-input-radio w-100" for="paymentMethod">Wybierz okres czasu:</label>
                </div>
                <div
                    class="bd-highlight balance-width2 margin-top-gap d-flex align-items-center justify-content-center">
                    <form action="/personalbudget/newbrowsethebalance" method="post">
                        <select class="form-select form-select-sm w-100" aria-label="sposob platnosci"
                            name="paymentMethod" id="paymentMethodSelected">
                            <option value="currentMonth">Bieżący miesiąc</option>
                            <option value="lastMonth">Poprzedni miesiąc</option>
                            <option value="currentYear" selected>Bieżący rok</option>
                            <option value="selectedPeriod">Wybrany okres</option>
                        </select>
                </div>
                <div
                    class="bd-highlight balance-width3 submit2 small-text d-flex align-items-center justify-content-center">
                    <button type="submit" class="btn btn-warning">Przeglądaj</button>
                </div>
                </form>
            </div>
            <div class="table-responsive">
                <table class="table-center my-table mb-4">
                    <thead>
                        <tr>
                            <th colspan="8" class="center-td">Zestawienie przychodów w okresie od
                                {{ date_from_to_current_year }}
                            </th>
                        </tr>
                        <tr>
                            <th class="ordinal-number">ID</th>
                            <th class="ordinal-number">Lp</th>
                            <th class="column-incomes">Kwota (zł)</th>
                            <th class="column-incomes">Data</th>
                            <th class="column-incomes">Kategoria</th>
                            <th class="column-incomes">Komentarz</th>
                            <th class="column-expenses">Edytuj</th>
                            <th class="column-expenses">Usuń</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if query_name_income_current_year %}
                        {% set myOrdinalNumber = 1 %}
                        {% for income in query_name_income_current_year %}
                        <tr>
                            <td class="ordinal-number">{{ income.incID }}</td>
                            <td class="ordinal-number">{{ myOrdinalNumber }}</td>
                            <td class="column-incomes">{{ income.amn }}</td>
                            <td class="column-incomes">{{ income.dateInc }}</td>
                            <td class="column-incomes">{{ income.incCategory }}</td>
                            <td class="column-incomes">{{ income.comment }}</td>
                            <td class="ordinal-number text-center">
                                <form method="post" action="/personalbudget/editIncomes" id="formDeleteExpanse"
                                    name="formDelete">
                                    <input type="hidden" name="editRowIncomes" value="{{ income.incID }}" />
                                    <button type="submit" class="btn btn-secondary" title="Edytuj">
                                        <!-- <button type="submit" class="btn btn-light"> -->
                                        <i class="icon-pencil"></i></button>
                                </form>
                            </td>
                            <td class="ordinal-number text-center">
                                <form method="post" action="/personalbudget/areYouSureDeleteFromIncomes"
                                    id="formDeleteExpanse" name="formDelete">
                                    <input type="hidden" name="deleteRowIncomes" value="{{ income.incID }}" />
                                    <input type="hidden" name="myOrdinalNumberDeleteIncomes"
                                        value="{{ myOrdinalNumber }}" />
                                    <!-- <button type="submit" class="btn btn-secondary" id="{{ expense.exID }}"> -->
                                    <button type="submit" class="btn btn-secondary" title="Usuń">
                                        <!-- <button type="submit" class="btn btn-light"> -->
                                        <i class="icon-trash-empty"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% set myOrdinalNumber = myOrdinalNumber + 1 %}
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="8" class="center-td">Brak przychodów</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
                <div id="chartContainer" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
                {% if chart_incomes_current_year %}
                {% for chart_income in chart_incomes_current_year %}
                {{ chart_income.incNameSum }} <br>
                <a href='#' data-entry-id='{{ chart_income.incNameSum }}' id='chart_icome_1'></a>
                {{ chart_income.catName }}<br>
                <a href="#" data-entry-id="{{ chart_income.catName }}" id="chart_icome_1"></a>
                {% endfor %}
                {% endif %}
            </div>
            <div class="table-responsive mt-4">
                <table class="table-center my-table mb-4">
                    <thead>
                        <tr>
                            <th colspan="9" class="center-td">Zestawienie wydatków w okresie od
                                {{ date_from_to_current_year }}
                            </th>
                        </tr>
                        <tr>
                            <th class="ordinal-number">ID</th>
                            <th class="ordinal-number">Lp</th>
                            <th class="column-expenses">Kwota (zł)</th>
                            <th class="column-expenses">Data</th>
                            <th class="column-expenses">Sposób płatności</th>
                            <th class="column-expenses">Kategoria</th>
                            <th class="column-expenses">Komentarz</th>
                            <th class="column-expenses">Edytuj</th>
                            <th class="column-expenses">Usuń</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if query_name_expense_current_year %}
                        {% set myOrdinalNumberExpenses = 1 %}
                        {% for expense in query_name_expense_current_year %}

                        <tr>
                            <td class="ordinal-number">{{ expense.exID }}</td>
                            <td class="ordinal-number">{{ myOrdinalNumberExpenses }}</td>
                            <td class="column-expenses">{{ expense.amn }}</td>
                            <td class="column-expenses">{{ expense.dateExp }}</td>
                            <td class="column-expenses">{{ expense.pay }}</td>
                            <td class="column-expenses">{{ expense.excategory }}</td>
                            <td class="column-expenses">{{ expense.comment }}</td>
                            <td class="ordinal-number text-center">
                                <form method="post" action="/personalbudget/editExpenses" id="formDeleteExpanse"
                                    name="formDelete">
                                    <input type="hidden" name="editRow" value="{{ expense.exID }}" />
                                    <button type="submit" class="btn btn-secondary" title="Edytuj">
                                        <!-- <button type="submit" class="btn btn-light"> -->
                                        <i class="icon-pencil"></i></button>
                                </form>
                            </td>
                            <td class="ordinal-number text-center">
                                <form method="post" action="/personalbudget/areYouSureDeleteFromExpenses"
                                    id="formDeleteExpanse" name="formDelete">
                                    <input type="hidden" name="deleteRow" value="{{ expense.exID }}" />
                                    <input type="hidden" name="myOrdinalNumberDeleteExpenses"
                                        value="{{ myOrdinalNumberExpenses }}" />
                                    <!-- <button type="submit" class="btn btn-secondary" id="{{ expense.exID }}"> -->
                                    <button type="submit" class="btn btn-secondary" title="Usuń">
                                        <!-- <button type="submit" class="btn btn-light"> -->
                                        <i class="icon-trash-empty"></i></button>
                                </form>
                            </td>

                        </tr>

                        {% set myOrdinalNumberExpenses = myOrdinalNumberExpenses + 1 %}
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="9" class="center-td">Brak wydatków</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
                <div id="chartContainerExpenses" style="height: 370px; max-width: 920px; margin: 0px auto;"
                    class="mb-2"></div>
                {% if chart_incomes_current_year %}
                {% for chart_income in chart_incomes_current_year %}
                <a href="#" data-entry-id="{{ chart_income.incNameSum }}" id="some_link_3"></a>
                <a href="#" data-entry-id="{{ chart_income.catName }}" id="some_link_4"></a>
                {% endfor %}
                {% endif %}
            </div>
            <div class="table-responsive mt-4">
                <table class="table-center">
                    <thead>
                        <tr>
                            <th>Suma przychodów i wydatków w okresie od {{ date_from_to_current_year }}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <p>Suma przychodów(zł):
                                    {% if query_name_incomes_sum_current_year.incSum %}
                                    <b> {{ query_name_incomes_sum_current_year.incSum }}
                                    </b>
                                    {% else %}
                                    <b>0</b>
                                    {% endif %}
                                </p>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <p>Suma wydatków (zł):
                                    {% if query_name_expenses_sum_current_year.expSum %}
                                    <b>{{ query_name_expenses_sum_current_year.expSum }}
                                    </b>
                                    {% else %}
                                    <b>0</b>
                                    {% endif %}
                                </p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- <script src="https://code.jquery.com/jquery-3.7.0.min.js"
    integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script> -->
{% endblock %}
{% block footer2 %}
<script>
    function myFunc() {
        const $entryElementsIncomes = $('#chart_icome_1[data-entry-id]');

        // console.log("Goła wartość: ", $entryElements4);

        const $entryDispalyArrayElementsIncome = $.map($entryElementsIncomes, item => $(item).data('entryId'));

        console.log("moje jest: ", $entryDispalyArrayElementsIncome);
        console.log("moje jest poj: ", $entryDispalyArrayElementsIncome[0]);
        console.log("długość: ", $entryDispalyArrayElementsIncome.length);



        let valueOfDataPoints = [];

        let sumChartIncomes = 0;

        let lastVal = 0;

        let singleVal = 0;

        let sumSingleVal = 0;

        for (let i = 0; i < $entryDispalyArrayElementsIncome.length - 1; i = i + 2) {
            sumChartIncomes += Number($entryDispalyArrayElementsIncome[i]);
            // if (i = $entryDispalyArrayElementsIncome.length - 2) {
            //     lastVal = 100 - sumChartIncomes;
            // }
        }



        console.log("lastVal ", lastVal);
        console.log("sumChartIncomes ", sumChartIncomes);

        // for (let i = 0; i < $entryDispalyArrayElementsIncome.length - 1; i = i + 2) {
        //     sumChartIncomes += Number($entryDispalyArrayElementsIncome[i]);
        // }

        for (let i = 0; i < $entryDispalyArrayElementsIncome.length - 1; i = i + 2) {

            // if ($entryDispalyArrayElementsIncome.length > 2) &&

            if (i == $entryDispalyArrayElementsIncome.length - 2) {
                lastVal = 100 - sumSingleVal;
                singleVal = lastVal;

                console.log(singleVal);
            } else {
                singleVal = Math.ceil((Number($entryDispalyArrayElementsIncome[i]) / sumChartIncomes) * 10000) / 100;
                sumSingleVal += singleVal;
                console.log("singleVal ", singleVal);
            }

            valueOfDataPoints.push({
                y: singleVal,
                label: $entryDispalyArrayElementsIncome[i + 1]
            });
        }
        return valueOfDataPoints;
    }


    // let help = Number($entryIds[0]) + Number($entryIds[2]) + Number($entryIds[4]);

    // console.log("help", help);

    // let entrtyIds1 = $entryIds[0] / help;

    // entrtyIds1 = entrtyIds1.toFixed(4) * 100;

    // console.log("entrtyIds1 ", entrtyIds1);

    // let entrtyIds2 = $entryIds[2] / help;

    // entrtyIds2 = entrtyIds2.toFixed(4) * 100;

    // let entrtyIds3 = $entryIds[4] / help;

    // entrtyIds3 = entrtyIds3.toFixed(4) * 100;


    window.onload = function () {

        var chart = new CanvasJS.Chart("chartContainer", {
            theme: "light2", // "light1", "light2", "dark1", "dark2"
            exportEnabled: true,
            animationEnabled: true,
            title: {
                text: "Zestawienie przychodów od {{ date_from_to_current_year }}"
            },
            data: [{
                type: "pie",
                startAngle: 25,
                toolTipContent: "<b>{label}</b>: {y}%",
                showInLegend: "true",
                legendText: "{label}",
                indexLabelFontSize: 16,
                indexLabel: "{label} - {y}%",
                // dataPoints: valueOfDataPoints
                dataPoints: myFunc()
            }]
        });
        chart.render();

        var chart = new CanvasJS.Chart("chartContainerExpenses", {
            theme: "light2", // "light1", "light2", "dark1", "dark2"
            exportEnabled: true,
            animationEnabled: true,
            title: {
                text: "Zestawienie przychodów od {{ date_from_to_current_year }}"
            },
            data: [{
                type: "pie",
                startAngle: 25,
                toolTipContent: "<b>{label}</b>: {y}%",
                showInLegend: "true",
                legendText: "{label}",
                indexLabelFontSize: 16,
                indexLabel: "{label} - {y}%",
                dataPoints: [{
                        y: 25,
                        label: "Moje1"
                    },
                    {
                        y: 50,
                        label: "Moje2"
                    },
                    {
                        y: 25,
                        label: "Moje3"
                    }
                    // {
                    //     y: 5.02,
                    //     label: "Another"
                    // },
                    // {
                    //     y: 4.07,
                    //     label: "Safari"
                    // },
                    // {
                    //     y: 1.22,
                    //     label: "Opera"
                    // },
                    // {
                    //     y: 0.44,
                    //     label: "Others"
                    // }
                ]
            }]
        });
        chart.render();

    }
</script>
<script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
{% endblock %}